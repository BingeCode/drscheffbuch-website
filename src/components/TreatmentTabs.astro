---
const defaultTab = "botox";
const baseId = "treatment-tabs";
---

<section id="Behandlungen" data-treatment-tabs data-default-tab={defaultTab}>
  <div>
    <h2 style="text-align: center;">Ich interessiere mich f√ºr...</h2>
    <!-- sr-only for screenreader context -->
    <h2 class="sr-only" id={`${baseId}-label`}>Behandlungen</h2>
    <div class="tablist-sticky">
      <div class="tablist" role="tablist" aria-labelledby={`${baseId}-label`}>
        <button
          type="button"
          class="tab"
          id={`${baseId}-tab-botox`}
          role="tab"
          aria-selected="true"
          aria-controls={`${baseId}-panel-botox`}
          tabindex="0"
          data-tab-value="botox">
          Botulinumtoxin
        </button>
        <button
          type="button"
          class="tab"
          id={`${baseId}-tab-filler`}
          role="tab"
          aria-selected="false"
          aria-controls={`${baseId}-panel-filler`}
          tabindex="0"
          data-tab-value="filler">
          Filler
        </button>
        <!-- <button
            type="button"
            class="tab"
            id={`${baseId}-tab-fettweg`}
            role="tab"
            aria-selected="false"
            aria-controls={`${baseId}-panel-fettweg`}
            tabindex="0"
            data-tab-value="fettweg">
            Fett-weg Spritze
          </button> -->
      </div>
    </div>
    <div
      class="panel"
      id={`${baseId}-panel-botox`}
      role="tabpanel"
      tabindex="-1"
      aria-labelledby={`${baseId}-tab-botox`}>
      <slot name="botox" />
      <!-- <div style="height: 100px;"></div> -->
    </div>

    <div
      class="panel"
      id={`${baseId}-panel-filler`}
      role="tabpanel"
      tabindex="-1"
      aria-labelledby={`${baseId}-tab-filler`}
      hidden>
      <slot name="filler" />
      <!-- <div style="height: 100px;"></div> -->
    </div>

    <!-- <div
      class="panel"
      id={`${baseId}-panel-fettweg`}
      role="tabpanel"
      tabindex="-1"
      aria-labelledby={`${baseId}-tab-fettweg`}
      hidden>
      <slot name="fettweg" />
      <div style="height: 100px;"></div>
    </div> -->
  </div>
</section>

<script type="module" is:inline>
  const root = document.querySelector("[data-treatment-tabs]");

  if (root) {
    root.dataset.enhanced = "true";

    const tablist = root.querySelector('[role="tablist"]');
    const tabs = Array.from(root.querySelectorAll('[role="tab"]'));

    const getPanelId = (tab) => {
      const panelId = tab.getAttribute("aria-controls");
      return panelId ? document.getElementById(panelId) : null;
    };

    const findScrollContainer = (startEl) => {
      /** @type {HTMLElement | null} */
      let el = startEl?.parentElement ?? null;

      while (el) {
        const style = window.getComputedStyle(el);
        const overflowY = style.overflowY;
        const isScrollable =
          (overflowY === "auto" || overflowY === "scroll") &&
          el.scrollHeight > el.clientHeight;

        if (isScrollable) return el;
        el = el.parentElement;
      }

      return document.scrollingElement;
    };

    const scrollContainer = findScrollContainer(root);

    const isWindowScroll =
      !scrollContainer ||
      scrollContainer === document.scrollingElement ||
      scrollContainer === document.documentElement ||
      scrollContainer === document.body;

    const getScrollTop = () => {
      if (isWindowScroll) {
        return window.scrollY || document.documentElement.scrollTop || 0;
      }
      return scrollContainer.scrollTop;
    };

    const getMaxScrollTop = () => {
      if (isWindowScroll) {
        const doc = document.documentElement;
        return Math.max(0, doc.scrollHeight - doc.clientHeight);
      }
      return Math.max(
        0,
        scrollContainer.scrollHeight - scrollContainer.clientHeight,
      );
    };

    const scrollToY = (top, behavior = "smooth") => {
      const clamped = Math.max(0, Math.min(top, getMaxScrollTop()));

      if (isWindowScroll) {
        window.scrollTo({ top: clamped, behavior });
        return;
      }

      scrollContainer.scrollTo({ top: clamped, behavior });
    };

    const getRootTopInScrollContainer = () => {
      const rootRect = root.getBoundingClientRect();

      if (isWindowScroll) {
        return (
          rootRect.top +
          (window.scrollY || document.documentElement.scrollTop || 0)
        );
      }

      const containerRect = scrollContainer.getBoundingClientRect();
      return rootRect.top - containerRect.top + scrollContainer.scrollTop;
    };

    const positionsByTab = new Map(); // tabValue -> scrollTop
    const visitedTabs = new Set(); // tabValue
    /** @type {HTMLElement | null} */
    let activeTab = null;

    const getTabKey = (tab) => tab.getAttribute("data-tab-value") || tab.id;

    const setActiveTab = (nextTab, { focus = true, scroll = false } = {}) => {
      if (!(nextTab instanceof HTMLElement)) return;

      // store current tab position before switching
      if (scroll && activeTab instanceof HTMLElement) {
        const prevKey =
          activeTab.getAttribute("data-tab-value") || activeTab.id;
        positionsByTab.set(prevKey, getScrollTop());
      }

      tabs.forEach((tab) => {
        const selected = tab === nextTab;
        tab.setAttribute("aria-selected", String(selected));

        const panel = getPanelId(tab);
        if (panel) panel.hidden = !selected;
      });

      activeTab = nextTab;

      if (scroll) {
        const key = nextTab.getAttribute("data-tab-value") || nextTab.id;

        // Only the first time a tab is clicked: scroll to the tabs (root)
        if (!visitedTabs.has(key)) {
          visitedTabs.add(key);
          scrollToY(getRootTopInScrollContainer(), "smooth");
        } else {
          const y = positionsByTab.get(key);
          if (typeof y === "number") scrollToY(y, "smooth");
        }
      }

      if (focus) nextTab.focus();
    };

    const focusTabByOffset = (currentTab, offset) => {
      const idx = tabs.indexOf(currentTab);
      if (idx === -1) return;
      const nextIdx = (idx + offset + tabs.length) % tabs.length;
      tabs[nextIdx].focus();
    };

    tablist?.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const tab = target.closest('[role="tab"]');
      if (!(tab instanceof HTMLElement)) return;

      setActiveTab(tab);
    });

    tablist?.addEventListener("keydown", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.getAttribute("role") !== "tab") return;

      switch (e.key) {
        case "ArrowRight":
        case "Right":
          e.preventDefault();
          focusTabByOffset(target, +1);
          break;
        case "ArrowLeft":
        case "Left":
          e.preventDefault();
          focusTabByOffset(target, -1);
          break;
        case "Home":
          e.preventDefault();
          tabs[0]?.focus();
          break;
        case "End":
          e.preventDefault();
          tabs[tabs.length - 1]?.focus();
          break;
        case "Enter":
        case " ":
          e.preventDefault();
          setActiveTab(target);
          break;
      }
    });

    const defaultTabValue = root.getAttribute("data-default-tab") || "botox";
    const initial =
      tabs.find((t) => t.getAttribute("data-tab-value") === defaultTabValue) ||
      tabs[0];

    if (initial) {
      setActiveTab(initial, { focus: false, scroll: false });

      visitedTabs.add(getTabKey(initial));

      // Seed its initial position and keep it updated via the scroll listener above.
      positionsByTab.set(getTabKey(initial), getScrollTop());
    }
  }
</script>
<style>
  .tabs {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .tabs-inner {
    display: flex;
    justify-content: center;
    padding: 1.5rem 0 0.5rem;
  }

  .tablist-sticky {
    position: sticky;
    top: 0;
    margin-bottom: 10rem;
    z-index: 10;
  }

  .tablist {
    margin: 0 auto;
    max-width: 350px;
    display: flex;
    overflow-x: auto;
    gap: 0.5rem;
    background: #fff;
    border: 1px solid #e5ecf9;
    border-radius: 999px;
    padding: 0.35rem;
    box-shadow: 0 2px 8px 0 rgba(9, 19, 49, 0.06);
  }

  .tab {
    min-width: fit-content;
    border: 0;
    background: transparent;
    color: inherit;
    padding: 0.65rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    cursor: pointer;
    line-height: 1;
    flex: 1;
  }

  .tab[aria-selected="true"] {
    background: var(--color--primary);
    color: #fff;
  }

  .tab:focus-visible {
    outline: 3px solid var(--color--primary);
    outline-offset: 2px;
  }

  .panels {
    margin-top: 1rem;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (max-width: 768px) {
    .tabs {
      padding: 0 1rem;
    }

    .tab {
      padding: 0.6rem 0.9rem;
    }
  }
</style>
